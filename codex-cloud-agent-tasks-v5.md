# Cloud Agent Task Brief â€” Testing Foundations v5

## Context Snapshot
- New server-side Jest suites (`__tests__/analytics-server.test.ts`, `__tests__/api-response.test.ts`) cover analytics normalization and API response helpers.
- `jest.setup.env.ts` now polyfills edge-runtime primitives so `NextResponse` works during tests.
- `jest.config.ts` still uses a single jsdom project with `jest.setup.ts` (React Testing Library) applied globally.
- Running the new server suites succeeds but leaves an open `MessagePort` handle because the jsdom/RTL setup file runs against node-style tests.

## Mission
Rework the Jest configuration so server-focused tests run in a pure Node environment without jsdom baggage, eliminating the lingering MessagePort handle while keeping component tests fully instrumented.

### 1. Configuration Split
- Convert `jest.config.ts` to use Jest projects (or an equivalent pattern) that separate jsdom/component tests from node/server tests.
- Ensure the server project skips `jest.setup.ts` and uses `testEnvironment: "node"` (while still loading `jest.setup.env.ts`).
- Confirm path patterns steer `__tests__/analytics-server.test.ts` and `__tests__/api-response.test.ts` into the server project, and UI specs remain in the jsdom project.

### 2. Setup Hygiene
- Audit `jest.setup.env.ts` and the new server environment: remove redundant polyfills if the server project no longer requires jsdom helpers.
- If additional polyfills are still needed, keep them scoped to the server project so component tests stay unaffected.
- Update or add server-specific teardown hooks if required to guarantee Jest exits cleanly.

### 3. Verification
- Run `npm test -- __tests__/analytics-server.test.ts __tests__/api-response.test.ts` and ensure Jest exits without `MessagePort` warnings.
- Run a representative React Testing Library test (e.g., `npm test -- app/**/__tests__/**`) to confirm the jsdom project still initializes correctly.

### 4. Documentation & Chores
- Record the new Jest project structure and run commands in `docs/build-plan/tasks/testing-and-quality-assurance/tasks.md` (Phase 1 checklist) and extend the highlights/next-steps section in `docs/build-plan/tasks/summary-2025-09-27.md` if behavior changes.
- Note any follow-up items (e.g., remaining suites to migrate) directly in the documents above.

## Constraints
- Keep the developer ergonomics simple (`npm test` should run both projects by default).
- Avoid introducing heavyweight dependencies; reuse Next/Edge primitives where possible.
- Maintain compatibility with the existing ts-jest/Next integration generated by `next/jest`.
